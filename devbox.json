{
  "$schema": "https://raw.githubusercontent.com/jetify-com/devbox/0.15.0/.schema/devbox.schema.json",
  "packages": [
    "go-task@latest",
    "act@latest",
    "gh@latest",
    "gum@latest",
    "yq-go@latest",
    "jq@latest",
    "kubectl@latest",
    "kubernetes-helm@latest",
    "kustomize@latest",
    "python312@latest",
    "poetry@latest",
    "nodejs_24@latest",
    "gnused@latest",
    "terraform@latest",
    "awscli@latest",
    "git@latest",
    "bash@latest",
    "starship@latest"
  ],
  "env": {
    "SECRET_KEY": "django-insecure-dev-key-for-local-devbox",
    "DB_NAME": "pmbok_db",
    "DB_USER": "pmbok_user",
    "DB_PASSWORD": "secretpassword123",
    "DB_HOST": "localhost",
    "DB_PORT": "5432",
    "DB_SSLMODE": "disable",
    "RUN_MIGRATIONS": "1",
    "RUN_SEED": "auto",
    "RUN_COLLECTSTATIC": "0",
    "VITE_API_URL": "http://localhost:8000/api",
    "CORS_ALLOWED_ORIGINS": "http://localhost:5173,http://127.0.0.1:5173",
    "CSRF_TRUSTED_ORIGINS": "http://localhost:5173,http://127.0.0.1:5173",
    "EXTRA_ALLOWED_HOSTS": "127.0.0.1,localhost",
    "DEVBOX_ENV_NAME": "ERD"
  },
  "shell": {
    "init_hook": [
      "# --- 0. NO auto-update: solo asegurar que .devtools exista (sin mover commits) ---",
      "sp=\"$(git rev-parse --show-superproject-working-tree 2>/dev/null || true)\"; root=\"${sp:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}\"; DEVTOOLS_PATH=\".devtools\";",
      "git -C \"$root\" submodule sync --recursive >/dev/null 2>&1 || true;",
      "git -C \"$root\" submodule update --init --recursive \"$DEVTOOLS_PATH\" >/dev/null 2>&1 || true;",
      "# --- 0.1 Aviso de versiÃ³n (NO muta, solo informa) ---",
      "if [[ \"${DEVTOOLS_SKIP_VERSION_CHECK:-0}\" != \"1\" ]]; then",
      "  DT_PATH=\"$root/$DEVTOOLS_PATH\";",
      "  DT_VERSION=\"$(cat \"$DT_PATH/VERSION\" 2>/dev/null | tr -d '[:space:]' || true)\";",
      "  DT_SHA=\"$(git -C \"$DT_PATH\" rev-parse --short HEAD 2>/dev/null || true)\";",
      "  DT_DESCRIBE=\"$(git -C \"$DT_PATH\" describe --tags --always 2>/dev/null || echo \"$DT_SHA\")\";",
      "  DT_LOCAL_TAG=\"$(git -C \"$DT_PATH\" describe --tags --abbrev=0 --match 'v*' 2>/dev/null || true)\";",
      "  DT_URL=\"$(git -C \"$root\" config -f \"$root/.gitmodules\" --get submodule..devtools.url 2>/dev/null || true)\";",
      "  DT_LATEST_TAG=\"\"; if [[ -n \"$DT_URL\" ]]; then DT_LATEST_TAG=\"$(git ls-remote --tags --refs \"$DT_URL\" 'refs/tags/v*' 2>/dev/null | awk -F/ '{print $3}' | sort -V | tail -n1)\"; fi;",
      "  echo \"ðŸ§° Devtools: base=${DT_VERSION:-unknown} Â· ${DT_DESCRIBE:-unknown}\";",
      "  if [[ -n \"$DT_LATEST_TAG\" && -n \"$DT_LOCAL_TAG\" && \"$DT_LOCAL_TAG\" != \"$DT_LATEST_TAG\" ]]; then",
      "    echo \"âš ï¸  Devtools desactualizado: Ãºltimo tag remoto $DT_LATEST_TAG (tÃº: $DT_LOCAL_TAG).\";",
      "    echo \"    Para actualizar (opt-in): git devtools-update\";",
      "  fi",
      "fi",
      "# --- 1. ConfiguraciÃ³n DinÃ¡mica de Alias Git (Auto-Discovery Robusto) ---",
      "echo 'ðŸ” Escaneando scripts y actualizando alias de Git...'",
      "# Determinamos dÃ³nde buscar dependiendo de si estamos en el root o dentro del submÃ³dulo",
      "if [[ \"$(basename \"$root\")\" == \".devtools\" ]]; then SEARCH_DIR=\"$root\"; else SEARCH_DIR=\"$root/.devtools\"; fi",
      "for tool in acp gp rp promote feature pr lim devtools-update; do",
      "  # Busca el archivo .sh recursivamente desde el directorio correcto",
      "  script_path=$(find \"$SEARCH_DIR\" -name \"git-$tool.sh\" -print -quit 2>/dev/null)",
      "  if [[ -n \"$script_path\" ]]; then",
      "    # Sobrescribe el alias apuntando a la ruta absoluta encontrada",
      "    git config alias.$tool \"!f(){ bash \\\"$script_path\\\" \\\"\\$@\\\"; }; f\"",
      "  else",
      "    echo \"âš ï¸  No se encontrÃ³ git-$tool.sh en $SEARCH_DIR\";",
      "  fi",
      "done",
      "# --- 2. The Gatekeeper: Setup Wizard (Smart Launch) ---",
      "WIZARD_SCRIPT=$(find \"$SEARCH_DIR\" -name \"setup-wizard.sh\" -print -quit 2>/dev/null)",
      "if [[ -n \"$WIZARD_SCRIPT\" && \"${DEVTOOLS_SKIP_WIZARD:-0}\" != \"1\" ]]; then",
      "  WIZARD_ARGS=\"\"",
      "  # Detectar marker de completado en el root correcto",
      "  if [ -f \"$root/.devtools/.setup_completed\" ]; then WIZARD_ARGS=\"--verify-only\"; fi",
      "  # Detectar modo no-interactivo (no TTY)",
      "  if [ ! -t 0 ] || [ ! -t 1 ]; then WIZARD_ARGS=\"--verify-only\"; fi",
      "  ",
      "  # Ejecutar wizard (si falla verify, NO rompemos shell init gracias a || true)",
      "  bash \"$WIZARD_SCRIPT\" $WIZARD_ARGS || true",
      "else",
      "  [ -z \"$WIZARD_SCRIPT\" ] && echo 'âš ï¸  Setup Wizard no encontrado.'",
      "fi",
      "# --- 3. Mensajes de Bienvenida ---",
      "echo 'ðŸš€ ERD Ecosystem Devbox Loaded!'",
      "echo 'âœ… Database credentials & SSL settings applied automatically.'",
      "echo 'ðŸ’¡ Try running: devbox run backend'",
      "# --- 4. Menu Simplificado (Fallback Seguro) ---",
      "if [[ -t 0 && -t 1 ]]; then DEVX_CHOICE=\"\"; if command -v gum >/dev/null 2>&1; then DEVX_CHOICE=\"$(gum choose --header \"Selecciona tu Rol:\" \"Admin\" \"Dev\" \"Ops\")\"; else echo \"Selecciona tu Rol:\"; select opt in \"Admin\" \"Dev\" \"Ops\"; do DEVX_CHOICE=\"$opt\"; break; done; fi; case \"$DEVX_CHOICE\" in \"Admin\") export DEVBOX_ENV_NAME=\"ERD\" ;; \"Dev\") export DEVBOX_ENV_NAME=\"PMBOK\" ;; \"Ops\") export DEVBOX_ENV_NAME=\"GITOPS\" ;; *) export DEVBOX_ENV_NAME=\"${DEVBOX_ENV_NAME:-DEVBOX}\" ;; esac; devx() { export DEVBOX_ENV_NAME=\"$1\"; }; fi",
      "# --- 5. Prompt: Starship ---",
      "if command -v starship >/dev/null 2>&1; then sp=\"$(git rev-parse --show-superproject-working-tree 2>/dev/null || true)\"; root=\"${sp:-$(git rev-parse --show-toplevel 2>/dev/null || pwd)}\"; export STARSHIP_CONFIG=\"$root/.starship.toml\"; if [[ -n \"${ZSH_VERSION:-}\" ]]; then eval \"$(starship init zsh)\"; else eval \"$(starship init bash)\"; fi; else if [[ -n \"${ZSH_VERSION:-}\" ]]; then export PROMPT=\"(devbox ${DEVBOX_ENV_NAME}) ${PROMPT}\"; else export PS1=\"(devbox ${DEVBOX_ENV_NAME}) ${PS1}\"; fi; fi"
    ]
  },
  "scripts": {
    "backend": "cd apps/pmbok/backend && chmod +x entrypoint.sh && poetry run ./entrypoint.sh python manage.py runserver 0.0.0.0:8000",
    "frontend": "cd apps/pmbok/frontend && npm run dev",
    "setup-k8s": "./devops/scripts/setup-cluster.sh",
    "acp": "bash $(find . -name git-acp.sh -print -quit)",
    "gp": "bash $(find . -name git-gp.sh -print -quit)",
    "rp": "bash $(find . -name git-rp.sh -print -quit)",
    "promote": "bash $(find . -name git-promote.sh -print -quit)",
    "feature": "bash $(find . -name git-feature.sh -print -quit)"
  }
}
# /webapps/erd-ecosystem/.devtools/.github/workflows/final-tags-guard.yml
name: final-tags-guard

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write  # necesario para crear la GitHub Release

jobs:
  verify-final-tag-from-main:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify final tag is from main (skip RC tags)
        run: |
          TAG="${GITHUB_REF_NAME}"

          # Si es RC, este workflow no aplica
          if [[ "$TAG" == *"-rc"* ]]; then
            echo "RC tag detected ($TAG). Skipping final-tag guard."
            exit 0
          fi

          TAG_SHA="$(git rev-list -n1 "$TAG")"
          git fetch origin main:refs/remotes/origin/main --force

          echo "Tag: $TAG"
          echo "Tag sha: $TAG_SHA"
          echo "origin/main: $(git rev-parse origin/main)"

          # El commit del tag debe estar contenido en main
          git merge-base --is-ancestor "$TAG_SHA" origin/main

      - name: Create GitHub release (final)
        if: ${{ !contains(github.ref_name, '-rc') }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          prerelease: false
